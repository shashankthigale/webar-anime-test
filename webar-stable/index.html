<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebAR Image Tracking Experience</title>

    <!-- Load A-Frame first -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- THREE.js for additional utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r150/three.min.js"></script>

    <!-- Load MindAR after A-Frame (using more reliable CDN) -->
    <script src="https://unpkg.com/mindar-image-aframe@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <!-- Fallback for MindAR loading -->
    <script>
      // Check if MindAR loaded properly
      setTimeout(() => {
        if (typeof window.MINDAR === "undefined") {
          console.error("‚ùå MindAR library failed to load");
          alert(
            "Failed to load MindAR library. Please check your internet connection and refresh the page."
          );
        } else {
          console.log("‚úÖ MindAR library loaded successfully");
        }
      }, 3000);
    </script>

    <!-- Application styles and scripts -->
    <link rel="stylesheet" href="./styles/app.css" />
    <script src="./scripts/smoothing.js"></script>
    <script src="./scripts/recorder.js"></script>
    <script src="./scripts/ui.js"></script>
  </head>
  <body>
    <!-- Hidden canvas for composite recording -->
    <!-- This canvas is used by the recorder to mix camera feed with AR overlays -->
    <canvas id="mix-canvas" style="display: none"></canvas>

    <!-- A-Frame scene with MindAR image tracking -->
    <a-scene
      mindar="imageTargetSrc: ./assets/targets.mind; filterMinCF: 0.02; filterBeta: 60; warmupTolerance: 3; missTolerance: 3;"
      renderer="logarithmicDepthBuffer: true; colorManagement: true;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <!-- Assets for the AR experience -->
      <a-assets>
        <!-- Overlay video that will be displayed on the tracked target -->
        <!-- Note: Replace ./assets/overlay.mp4 with your actual overlay video -->
        <video
          id="overlay-video"
          src="./assets/overlay.mp4"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
          muted
        ></video>
      </a-assets>

      <!-- Camera entity with MindAR -->
      <a-camera look-controls="enabled: false"></a-camera>

      <!-- Image target entity with smooth-follow component -->
      <!--
            MindAR Configuration Notes:
            - filterMinCF: Minimum cutoff frequency for One-Euro filter (lower = more smoothing but more lag)
            - filterBeta: Speed coefficient for adaptive cutoff (higher = more responsive to fast motion)
            - warmupTolerance: Frames to wait before considering target found (higher = more stable detection)
            - missTolerance: Frames to wait before considering target lost (higher = more stable tracking)

            Tuning Guidelines:
            1. Start with filterMinCF around 0.02 and filterBeta around 60
            2. Lower filterMinCF to reduce jitter at slow motions, but watch for added lag
            3. Increase filterBeta to improve responsiveness during fast motion
            4. Adjust warmupTolerance/missTolerance based on target stability requirements
        -->
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- Video plane that follows the tracked marker with smoothing -->
        <!--
                Smooth-Follow Component Notes:
                - anchor: The marker entity to follow
                - overscan: Scale multiplier to hide edge wobble (1.02-1.03 recommended)
                - alphaMin: Minimum lerp factor for slow motions (lower = more smoothing)
                - alphaMax: Maximum lerp factor for fast motions (higher = more responsive)

                The component implements double smoothing:
                1. MindAR's built-in One-Euro filter on marker pose
                2. Content-side One-Euro filter on the placed media node
            -->
        <a-video
          id="video-plane"
          src="#overlay-video"
          width="1"
          height="0.5625"
          <!--
          16:9
          aspect
          ratio
          --
        >
          position="0 0 0" smooth-follow="anchor: #marker; overscan: 1.02;
          alphaMin: 0.12; alphaMax: 0.22">
        </a-video>
      </a-entity>
    </a-scene>

    <!-- Initialize the UI system when DOM is ready -->
    <script>
      // Initialize the WebAR application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ WebAR Image Tracking App loading...");

        // Check if required libraries loaded
        console.log("A-Frame loaded:", !!window.AFRAME);
        console.log("THREE.js loaded:", !!window.THREE);

        // Initialize the UI system (creates start overlay and controls)
        try {
          initUI();
          console.log("‚úÖ UI system initialized");
        } catch (error) {
          console.error("‚ùå Failed to initialize UI:", error);
        }

        // Optional: Log version info for debugging
        console.log("WebAR Image Tracking App initialized");
        console.log("A-Frame version:", AFRAME?.version);

        // Check if MindAR loaded after a delay
        setTimeout(() => {
          console.log("üîç Checking MindAR status...");
          console.log("MindAR global available:", !!window.MINDAR);

          const scene = document.querySelector("a-scene[mindar]");
          console.log("MindAR scene element:", !!scene);
          console.log("MindAR instance:", !!scene?.mindar);

          if (!window.MINDAR) {
            console.warn("‚ö†Ô∏è MindAR library not loaded. Check CDN connection.");
          }
          if (!scene) {
            console.warn(
              "‚ö†Ô∏è MindAR scene not found. Check if A-Frame loaded correctly."
            );
          }
          if (!scene?.mindar) {
            console.warn(
              "‚ö†Ô∏è MindAR not initialized on scene. Check loading order."
            );
          }
        }, 3000);
      });

      // Error handling for unsupported browsers
      window.addEventListener("error", function (event) {
        console.error("‚ùå WebAR App Error:", event.error);
        console.error("Error filename:", event.filename);
        console.error("Error line:", event.lineno);

        // Show user-friendly error message
        if (
          event.error &&
          event.error.message &&
          event.error.message.includes("getUserMedia")
        ) {
          alert(
            "Camera access is required for this AR experience. Please allow camera permissions and reload the page."
          );
        }
      });

      // Monitor script loading
      window.addEventListener("load", function () {
        console.log("‚úÖ All scripts loaded");
      });
    </script>

    <!--
        WebAR Image Tracking App

        Features:
        - Image target tracking with MindAR
        - Double smoothing (MindAR built-in + content-side One-Euro filter)
        - Composite recording (camera + AR overlays)
        - iOS-compatible tap-to-start overlay
        - Development tuning panel (localhost only)

        Requirements:
        - Modern browser with WebRTC support
        - Camera permissions
        - HTTPS (for production) or localhost (for development)

        Target Image Guidelines:
        - Use flat, matte, high-detail images
        - Avoid symmetry and repeating patterns
        - Ensure good contrast and even lighting
        - Fill a significant portion of camera FOV

        Performance Notes:
        - Scenes are kept lightweight for smooth performance
        - Pre-allocated vectors/quaternions to avoid garbage collection
        - Adaptive smoothing reduces jitter while maintaining responsiveness

        Platform Notes:
        - iOS Safari: Works with MindAR's custom pipeline (no WebXR API exposure)
        - Android Chrome: Full WebXR support available
        - Desktop: Limited camera support (requires compatible webcam)
    -->
  </body>
</html>
