<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebAR Image Tracking Experience</title>

    <!-- A-Frame + extras + MindAR (working combination from reference) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <!-- Application styles and scripts -->
    <link rel="stylesheet" href="./styles/app.css" />
    <script src="./scripts/smoothing.js"></script>
    <script src="./scripts/recorder.js"></script>
    <script src="./scripts/ui.js"></script>
  </head>
  <body>
    <!-- Hidden canvas for composite recording -->
    <!-- This canvas is used by the recorder to mix camera feed with AR overlays -->
    <canvas id="mix-canvas" style="display: none"></canvas>

    <!-- A-Frame scene with MindAR image tracking -->
    <a-scene
      mindar-image="imageTargetSrc: ./assets/targets.mind; autoStart: false; uiScanning: true; uiLoading: true; filterMinCF:0.05; filterBeta:40; warmupTolerance:3; missTolerance:3"
      embedded
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      id="ar-scene"
    >
      <!-- Assets for the AR experience -->
      <a-assets>
        <!-- Overlay video that will be displayed on the tracked target -->
        <!-- Note: Replace ./assets/overlay.mp4 with your actual overlay video -->
        <video
          id="overlay-video"
          src="./assets/overlay.mp4"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
          muted
        ></video>
      </a-assets>

      <!-- Camera entity with MindAR -->
      <a-camera look-controls="enabled: false"></a-camera>

      <!-- Image target entity -->
      <a-entity mindar-image-target="targetIndex: 0" id="video-target">
        <a-video
          id="video-plane"
          src="#overlay-video"
          width="1.3"
          height="1.7"
          position="0 0 0"
          rotation="0 0 0"
        >
        </a-video>
      </a-entity>

      <!-- Debug: Manual start button (in case auto-start fails) -->
      <a-entity
        position="0 0 -2"
        geometry="plane: width: 0.5; height: 0.2"
        material="color: red; transparent: true; opacity: 0.8"
        id="manual-start-btn"
      >
        <a-text
          value="Tap to Start Camera"
          position="0 0 0.01"
          align="center"
          color="white"
          width="2"
        ></a-text>
      </a-entity>
    </a-scene>

    <!-- Initialize the UI system when DOM is ready -->
    <script>
      // Initialize the WebAR application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üöÄ WebAR Image Tracking App loading...");

        // Check if required libraries loaded
        console.log("A-Frame loaded:", !!window.AFRAME);
        console.log("THREE.js loaded:", !!window.THREE);

        // Initialize the UI system (creates start overlay and controls)
        try {
          initUI();
          console.log("‚úÖ UI system initialized");
        } catch (error) {
          console.error("‚ùå Failed to initialize UI:", error);
        }

        // Optional: Log version info for debugging
        console.log("WebAR Image Tracking App initialized");
        console.log("A-Frame version:", AFRAME?.version);

        // Check initialization status
        setTimeout(() => {
          console.log("üîç Checking initialization status...");
          console.log("A-Frame loaded:", !!window.AFRAME);
          console.log("Document ready state:", document.readyState);

          const scene = document.querySelector("a-scene[mindar-image]");
          console.log("MindAR scene element:", !!scene);

          if (scene) {
            console.log("Scene attributes:", scene.getAttributeNames());
            console.log(
              "Scene mindar-image value:",
              scene.getAttribute("mindar-image")
            );
          }

          // Check all video elements
          const videos = document.querySelectorAll("video");
          console.log(`Found ${videos.length} video elements:`);
          videos.forEach((v, i) => {
            console.log(`  Video ${i}:`, {
              id: v.id,
              src: v.src || "no src",
              hasStream: !!(v.srcObject instanceof MediaStream),
              readyState: v.readyState,
            });
          });

          if (!scene) {
            console.warn(
              "‚ö†Ô∏è MindAR scene not found. Check if all libraries loaded correctly."
            );
          }
        }, 2000);
      });

      // Error handling for unsupported browsers
      window.addEventListener("error", function (event) {
        console.error("‚ùå WebAR App Error:", event.error);
        console.error("Error filename:", event.filename);
        console.error("Error line:", event.lineno);

        // Show user-friendly error message
        if (
          event.error &&
          event.error.message &&
          event.error.message.includes("getUserMedia")
        ) {
          alert(
            "Camera access is required for this AR experience. Please allow camera permissions and reload the page."
          );
        }
      });

      // Monitor script loading
      window.addEventListener("load", function () {
        console.log("‚úÖ All scripts loaded");
      });
    </script>

    <!--
        WebAR Image Tracking App

        Features:
        - Image target tracking with MindAR
        - Double smoothing (MindAR built-in + content-side One-Euro filter)
        - Composite recording (camera + AR overlays)
        - iOS-compatible tap-to-start overlay
        - Development tuning panel (localhost only)

        Requirements:
        - Modern browser with WebRTC support
        - Camera permissions
        - HTTPS (for production) or localhost (for development)

        Target Image Guidelines:
        - Use flat, matte, high-detail images
        - Avoid symmetry and repeating patterns
        - Ensure good contrast and even lighting
        - Fill a significant portion of camera FOV

        Performance Notes:
        - Scenes are kept lightweight for smooth performance
        - Pre-allocated vectors/quaternions to avoid garbage collection
        - Adaptive smoothing reduces jitter while maintaining responsiveness

        Platform Notes:
        - iOS Safari: Works with MindAR's custom pipeline (no WebXR API exposure)
        - Android Chrome: Full WebXR support available
        - Desktop: Limited camera support (requires compatible webcam)
    -->
  </body>
</html>
