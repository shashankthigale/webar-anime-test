<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebAR Image Tracking</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <link rel="stylesheet" href="./styles/app.css" />
    <script src="./scripts/smoothing.js"></script>
    <script src="./scripts/recorder.js"></script>
    <script src="./scripts/ui.js"></script>
  </head>
  <body>
    <!-- === POINTER EVENTS FIX START === -->
    <div id="start-overlay">
      <button id="start-button">Tap to Start</button>
    </div>
    <!-- === POINTER EVENTS FIX END === -->

    <div id="controls">
      <button id="record-button">Record</button>
      <label><input type="checkbox" id="mic-checkbox" /> Include Mic</label>
      <a id="download-link" style="display: none">Download</a>
    </div>

    <div id="dev-panel" style="display: none">
      <h3>Tuning Panel</h3>
      <div>
        <label
          >filterMinCF:
          <input type="number" id="filterMinCF" step="0.001" value="0.02"
        /></label>
      </div>
      <div>
        <label
          >filterBeta: <input type="number" id="filterBeta" step="1" value="60"
        /></label>
      </div>
      <div>
        <label
          >alphaMin:
          <input type="number" id="alphaMin" step="0.01" value="0.12"
        /></label>
      </div>
      <div>
        <label
          >alphaMax:
          <input type="number" id="alphaMax" step="0.01" value="0.22"
        /></label>
      </div>
      <div>
        <label
          >overscan:
          <input type="number" id="overscan" step="0.01" value="1.02"
        /></label>
      </div>
      <div>
        <label
          >Smoother: <input type="checkbox" id="smoother-toggle" checked
        /></label>
      </div>
      <button id="reset-tuning">Reset</button>
    </div>

    <canvas id="mix-canvas" style="display: none"></canvas>

    <!-- 
    MindAR Scene Configuration:
    - imageTargetSrc: Path to the compiled target file.
    - filterMinCF (mincutoff): Lower values reduce jitter but increase lag. Good starting point: 0.001-0.05.
    - filterBeta: Higher values reduce lag during fast motion. Good starting point: 10-100.
    - warmupTolerance: Number of frames to wait before showing the target after detection.
    - missTolerance: Number of frames to wait before hiding the target after it's lost.
  -->
    <a-scene
      mindar-image="imageTargetSrc: ./assets/targets.mind; filterMinCF: 0.02; filterBeta: 60; warmupTolerance: 3; missTolerance: 3;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      renderer="colorManagement: true;"
      id="ar-scene"
      style="pointer-events: none"
    >
      <a-assets>
        <video
          id="overlay-video"
          src="./assets/overlay.mp4"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
          loop="true"
        ></video>
      </a-assets>

      <a-camera look-controls="enabled: false" fov="80"></a-camera>

      <a-entity id="marker" mindar-image-target="targetIndex: 0">
        <!-- 
        The video plane uses the smooth-follow component for stabilization.
        - anchor: The #marker entity whose pose we will smooth.
        - overscan: Scales the plane slightly to hide edge wobble (1.02 = 2% bigger).
        - alphaMin/alphaMax: Clamps the adaptive smoothing factor.
      -->
        <a-video
          id="video-plane"
          src="#overlay-video"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          smooth-follow="anchor: #marker; overscan: 1.02; alphaMin: 0.12; alphaMax: 0.22;"
        ></a-video>
      </a-entity>
    </a-scene>
  </body>
</html>
