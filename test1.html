<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Testing — Composite Recording (Camera + AR)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- A-Frame + extras + MindAR -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:sans-serif; }
      #start-overlay{
        position:fixed; inset:0; background:#000; color:#fff; z-index:999;
        display:flex; flex-direction:column; justify-content:center; align-items:center;
      }
      #start-button{
        padding:14px 28px; font-size:16px; background:#00cec9; color:#fff;
        border:0; border-radius:6px; cursor:pointer; margin-top:12px;
      }
      #rec-controls{
        position:fixed; bottom:12px; left:12px; z-index:9999;
        display:flex; gap:8px; align-items:center;
        background:rgba(0,0,0,.55); color:#fff; padding:8px 10px; border-radius:10px;
      }
      #rec-toggle{
        padding:10px 14px; border:0; border-radius:6px; background:#e63946; color:#fff; cursor:pointer;
      }
      #dl{
        background:#0a7; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; display:none;
      }
      #mic-label{ background:#000a; color:#fff; padding:6px 8px; border-radius:6px; }
    </style>

    <!-- Pose smoothing component (content-side) -->
    <script>
      // A-Frame component that follows an anchor with smoothing (pos/rot/scale)
      AFRAME.registerComponent('smooth-follow', {
        schema: { target: { type: 'selector' }, alpha: { default: 0.15 } },
        init() {
          this.tmpPos = new THREE.Vector3();
          this.tmpQuat = new THREE.Quaternion();
          this.tmpScale = new THREE.Vector3(1,1,1);
          this.sPos = new THREE.Vector3();
          this.sQuat = new THREE.Quaternion();
          this.sScale = new THREE.Vector3(1,1,1);
          this.initialized = false;
        },
        tick() {
          const anchor = this.data.target;
          if (!anchor) return;
          const aobj = anchor.object3D;
          aobj.getWorldPosition(this.tmpPos);
          aobj.getWorldQuaternion(this.tmpQuat);
          aobj.getWorldScale(this.tmpScale);

          if (!this.initialized) {
            this.sPos.copy(this.tmpPos);
            this.sQuat.copy(this.tmpQuat);
            this.sScale.copy(this.tmpScale);
            this.initialized = true;
          } else {
            const a = this.data.alpha;
            this.sPos.lerp(this.tmpPos, a);
            this.sQuat.slerp(this.tmpQuat, a);
            this.sScale.lerp(this.tmpScale, a);
          }

          const o = this.el.object3D;
          o.position.copy(this.sPos);
          o.quaternion.copy(this.sQuat);
          o.scale.copy(this.sScale);
        }
      });
    </script>
  </head>

  <body>
    <!-- Tap-to-start overlay (unlocks media on iOS) -->
    <div id="start-overlay">
      <h1>Tap to Start AR Experience</h1>
      <button id="start-button">Start</button>
    </div>

    <!-- Composite-record controls (camera + AR overlays) -->
    <div id="rec-controls">
      <button id="rec-toggle">● Record Camera + AR</button>
      <label id="mic-label"><input id="include-mic" type="checkbox"> Include mic</label>
      <a id="dl" download>Download</a>
    </div>

    <!-- Hidden mixer canvas (we record this) -->
    <canvas id="mix-canvas" style="display:none;"></canvas>

    <!-- A-Frame Scene -->
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true; uiScanning: true; uiLoading: true; filterMinCF:0.05; filterBeta:40; warmupTolerance:3; missTolerance:3"
      embedded
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      id="ar-scene"
    >
      <a-assets>
        <!-- Overlay video (NOT the camera).
             Note: start as muted to pass autoplay rules, we'll unmute after the Start click. -->
        <video
          id="ad-video"
          src="./video.mp4"
          preload="auto"
          crossorigin="anonymous"
          playsinline
          webkit-playsinline
          muted
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- MindAR anchor (empty; we just listen to its events & read its pose) -->
      <a-entity mindar-image-target="targetIndex: 0" id="video-target"></a-entity>

      <!-- Smoothed follower (NOT parented to anchor). Content goes here. -->
      <a-entity id="smooth-follow" smooth-follow="target: #video-target; alpha: 0.15" visible="false">
        <!-- Slight overscan to hide sub-pixel wiggle -->
        <a-video
          id="video-plane"
          src="#ad-video"
          width="1.326"
          height="1.734"
          position="0 0 0"
          rotation="0 0 0"
        ></a-video>
      </a-entity>
    </a-scene>

    <script>
      const startButton = document.getElementById("start-button");
      const overlay = document.getElementById("start-overlay");
      const sceneEl = document.getElementById("ar-scene");
      const video = document.getElementById("ad-video");
      const target = document.getElementById("video-target");
      const smoothFollowEl = document.getElementById("smooth-follow");

      const recBtn  = document.getElementById('rec-toggle');
      const dl      = document.getElementById('dl');
      const micBox  = document.getElementById('include-mic');
      const mixCanvas = document.getElementById('mix-canvas');
      let mixCtx, rafId;

      let audioUnlocked = false;
      let cameraVideoEl = null;   // MindAR's hidden <video> with srcObject MediaStream
      let mediaRecorder, chunks = [];
      let audioCtx, dest, micStream = null;
      let recording = false;

      // Unlock media on user gesture; prime the video element for later programmatic play
      startButton.addEventListener("click", async () => {
        try {
          // unmute now that we have a real gesture; then do a quick play/pause to "unlock"
          video.muted = false;
          await video.play();
          video.pause();
        } catch(e) {
          // fallback: keep muted if needed for autoplay rules
          video.muted = true;
        }
        audioUnlocked = true;
        overlay.style.display = "none";
      });

      // Show/hide smoothed content + control playback based on marker visibility
      target.addEventListener("targetFound", async () => {
        smoothFollowEl.setAttribute('visible', true);
        try { await video.play(); } catch(e) { /* ignore if blocked; still visible */ }
      });
      target.addEventListener("targetLost",  () => {
        smoothFollowEl.setAttribute('visible', false);
        try { video.pause(); } catch(_) {}
      });

      // MindAR ready -> find the camera <video> MindAR created
      sceneEl.addEventListener("arReady", () => {
        const vids = Array.from(document.querySelectorAll('video'));
        cameraVideoEl = vids.find(v => v !== video && v.srcObject instanceof MediaStream);
      });

      function pickMime() {
        const prefs = [
          'video/mp4;codecs=avc1.42E01E,mp4a.40.2',
          'video/webm;codecs=vp9,opus',
          'video/webm;codecs=vp8,opus',
          'video/webm'
        ];
        return prefs.find(t => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || '';
      }

      function sizeMixCanvas() {
        const camW = cameraVideoEl?.videoWidth || 0;
        const camH = cameraVideoEl?.videoHeight || 0;
        const sceneCanvas = sceneEl.canvas;
        const w = camW || sceneCanvas?.width || 1280;
        const h = camH || sceneCanvas?.height || 720;
        mixCanvas.width = w;
        mixCanvas.height = h;
        if (!mixCtx) mixCtx = mixCanvas.getContext('2d', { alpha: true });
      }

      function drawComposite() {
        const sceneCanvas = sceneEl.canvas;
        if (!cameraVideoEl || !sceneCanvas) { raf
